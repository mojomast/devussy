# DevUssY Local Development Fixes - November 26, 2025

## Issues Fixed

### 1. **ClientDisconnect Error on `/api/interview` endpoint**
**Problem:** Analytics middleware was consuming `request.body()` which exhausted the stream before endpoint handlers could read it.

**Fix:** Removed `await request.body()` call from `AnalyticsMiddleware.dispatch()` in `streaming_server/app.py` (line ~84). Now sets `request_size = 0` instead of reading body.

**Impact:** ✅ All POST endpoints now work without socket hang up errors

---

### 2. **CORS Issues (Frontend can't reach backend)**
**Problem:** FastAPI backend wasn't sending proper CORS headers for local Next.js frontend on port 3000.

**Fix:** Added `CORSMiddleware` to `streaming_server/app.py`:
```python
from fastapi.middleware.cors import CORSMiddleware

# Configure CORS origins based on environment
allowed_origins_env = os.getenv("ALLOWED_ORIGINS", "")
if allowed_origins_env:
    # Production: use env var (comma-separated list)
    allowed_origins = [origin.strip() for origin in allowed_origins_env.split(",")]
else:
    # Local development: allow localhost
    allowed_origins = ["http://localhost:3000", "http://127.0.0.1:3000"]

app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**Docker/VPS Compatibility:** Set `ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com` in production env.

**Impact:** ✅ Frontend can now call backend APIs without proxy errors

---

### 3. **TypeError: Cannot read properties of undefined (reading 'replace')**
**Problem:** `formatBucket()` function in `ComplexityAssessment.tsx` didn't handle undefined/null bucket names from backend responses.

**Fix:** Made function defensive:
```typescript
function formatBucket(bucket: string | undefined | null): string {
    if (!bucket) return 'N/A';
    return bucket
        .replace(/_/g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase());
}
```

**Additional Fixes:**
- Made `ComplexityProfile` interface fields optional (`project_type_bucket?`, `score?`, etc.)
- Added `getScore()` helper to safely extract score from either `score` or `complexity_score` fields
- Updated all `profile.score` usages to use `getScore(profile)` 

**Impact:** ✅ Complexity analysis UI no longer crashes on missing fields

---

## Quick Start

### Option 1: Use Launch Script (Recommended)
```powershell
cd c:\Users\kyle\projects\devussy04\devussy\devussy-web
.\start-dev-servers.ps1
```
Opens 2 PowerShell windows - one for backend, one for frontend.

### Option 2: Manual Start

**Terminal 1 (Backend):**
```powershell
cd c:\Users\kyle\projects\devussy04\devussy
$env:REQUESTY_API_KEY="your_key_here"
python -m uvicorn devussy-web.streaming_server.app:app --reload --port 8000
```

**Terminal 2 (Frontend):**
```powershell
cd c:\Users\kyle\projects\devussy04\devussy\devussy-web
npm run dev
```

### Verify Endpoints
```powershell
# Test backend models endpoint
curl http://localhost:8000/api/models

# Test backend health
curl http://localhost:8000/api/analytics/overview

# Open frontend
start http://localhost:3000
```

---

## Environment Variables

### Local Development
```powershell
$env:REQUESTY_API_KEY = "rqsty-sk-..."
$env:NODE_ENV = "development"
```

### Docker/VPS Production
```bash
REQUESTY_API_KEY=rqsty-sk-...
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
NODE_ENV=production
STREAMING_SECRET=your_secret_key
```

---

## Troubleshooting

### Models won't load
1. Check backend is running: `curl http://localhost:8000/api/models`
2. Check REQUESTY_API_KEY is set: `echo $env:REQUESTY_API_KEY`
3. Check Next.js proxy in browser DevTools Network tab

### "Failed to proxy" errors
1. Ensure backend started BEFORE frontend
2. Verify backend is on port 8000: `netstat -ano | findstr :8000`
3. Check `next.config.ts` has `USE_LOCAL_API` or `NODE_ENV=development`

### Backend crashes on startup
1. Check Python path: `python --version` (should be 3.11+)
2. Install deps: `pip install -r devussy-web/streaming_server/requirements.txt`
3. Check for port conflicts: `netstat -ano | findstr :8000`

### Frontend complexity analysis crashes
- Fixed! But if issues persist, check browser console for the exact error
- Verify backend `/api/adaptive/complexity` returns valid JSON with `profile` field

---

## Files Changed

- ✅ `devussy-web/streaming_server/app.py` - Fixed middleware, added CORS
- ✅ `devussy-web/src/components/pipeline/ComplexityAssessment.tsx` - Defensive null handling
- ✅ `devussy-web/start-dev-servers.ps1` - New launch script

## Next Steps

- [ ] Test full interview → design → complexity flow
- [ ] Test model selection dropdown
- [ ] Test validation and correction endpoints
- [ ] Prepare Docker deployment config with new env vars
